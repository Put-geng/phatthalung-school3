<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โรงเรียนพัทลุง</title>
    <link rel="stylesheet" href="CodeCSS/nav-bar.css">
    <link rel="icon" href="favicon-logo.png" type="image/png">
    <link rel="stylesheet" href="CodeCSS/Res-Menu.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <style>
        .bg {
            background: url('photo-Class/bg-contact.jpg')no-repeat center center/cover;
            filter: blur() brightness();
        }
    </style>
</head>
<body>
    <div class="bg"></div>

    <!--nav-bar-->
    <nav>
        <div class="navlogo">
            <img src="photo-Class/favicon-logo.png" alt="icon-image" class="nav-logo-img">
            <div class="nav-logo">โรงเรียนพัทลุง</div>
        </div>

        <div class="menu-icon" id="menu-icon">
            <span class="material-symbols-outlined hamberger-icon">dehaze</span>
        </div>

        <div class="nav-link" id="nav-link">
            <a href="Menu-Page.html" class="nav-link-active">
                <span class="material-symbols-outlined nav-icon food">menu_book_2</span>เมนูอาหาร
            </a>
            <a href="Check-class.html">
                <span class="material-symbols-outlined nav-icon">browse_gallery</span>ตรวจห้องเรียน
            </a>
            <a href="" id="NameUser" class="no-after">
                <span class="material-symbols-outlined nav-icon">account_box</span>ชื่อผู้ใช้
            </a>
        </div>
    </nav>

	<!--header-->
	<div class="inline-head">
			<div class="green">เมนูร้านที่ 1</div><div class="yellow">"น้ำ"</div>
	</div>

    <!--main-->
    <div class="container-menu">
        <div class="big-box-menu">
            <div class="small-box-menu">
                <div class="food-image">
                    <img src="photo-Class/Left-Res1-no1-1.jpg" alt="" class="food-photo">
                    <img src="" alt="" class="food-photo">
                </div>
                <div class="content-menu">
                    <h3></h3>
                    <p></p>

                    <div class="average-rating">
                        <span class="avg-stars">★★★★★</span>
                        <span class="avg-score">(0 คะแนน / 0 คน)</span>
                    </div>

                    <button class="rate-btn">ให้คะแนน</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Box -->
    <div id="ratingAlert" class="custom-alert-new">
        <div class="alert-content">
            <h3>ให้คะแนนเมนูนี้</h3>
            <div class="stars-rating"></div>
            <button id="submitRating">ส่งคะแนน</button>
            <button id="cancelRating">ยกเลิก</button>
        </div>
    </div>

    <!--alert-box-->
	<div id="alertBox" class="custom-alert">
		<img id="alertIcon" src="" alt="alertIcon" class="alert-icon">
		<span id="alertMessage" class="alertMessage"></span>
		<button id="alertOkBtn">OK</button>
		<button id="backbutton"><a href="index.html">กลับหน้า Login</a></button>
	</div>

    <script>
        const baseURL = "https://phatthalung-school3-shadow.vercel.app";
            
        // nav toggle
        document.getElementById('menu-icon').onclick = () => {
            document.getElementById('nav-link').classList.toggle('active');
        }
        
        // แสดงชื่อผู้ใช้
        const nameUser = document.getElementById('NameUser');
        window.addEventListener('load', () => {
            const savedEmail = localStorage.getItem('email') || "ไม่พบอีเมล";
            nameUser.innerHTML = `<span class="material-symbols-outlined">account_box</span>${savedEmail}`;
        });
        nameUser.addEventListener("click", (e) => {
            e.preventDefault();
            const savedName = localStorage.getItem('username') || "ไม่พบชื่อผู้ใช้";
            const savedEmail = localStorage.getItem('email') || "ไม่พบอีเมล";
            alert(`ชื่อผู้ใช้: ${savedName}\nอีเมล: ${savedEmail}`);
        });
        
        // ฟังก์ชันอัพเดตค่าเฉลี่ย
        function updateAverage(avgStarsElem, avgScoreElem, average, count) {
            avgStarsElem.innerHTML = '';
            for (let i=1; i<=5; i++) {
                const star = document.createElement('span');
                star.textContent = '★';
                if (i <= Math.floor(average)) star.style.color = 'gold';
                else if (i - 0.5 <= average) star.style.color = 'goldenrod';
                else star.style.color = 'gray';
                avgStarsElem.appendChild(star);
            }
            avgScoreElem.textContent = `${average.toFixed(1)} (${count} คน)`;
        }
        
        // โหลดค่าเฉลี่ยตอนหน้าโหลด
        async function loadAverage(menuId, box) {
            const res = await fetch(`${baseURL}/api/average/${menuId}`);
            const data = await res.json();
            const avgStars = box.querySelector('.avg-stars');
            const avgScore = box.querySelector('.avg-score');
            updateAverage(avgStars, avgScore, data.average, data.count);
        }
        
        // rate button
        document.querySelectorAll('.small-box-menu').forEach((box,index)=>{
            const menuId = index+1;
            const rateBtn = box.querySelector('.rate-btn');
        
            loadAverage(menuId, box); // โหลดค่าเฉลี่ยตอนเริ่ม
        
            rateBtn.addEventListener('click', ()=>{
                const overlay = document.getElementById('overlay');
                const starsContainer = document.getElementById('stars-container');
                overlay.style.display = 'block';
                starsContainer.innerHTML = '';
                let selected = 0;
            
                // สร้างดาวให้คลิกได้
                for (let i=1;i<=5;i++){
                    const star = document.createElement('span');
                    star.textContent = '★';
                    star.classList.add('star');
                    star.addEventListener('click', ()=>{ selected=i; updateStars(); });
                    starsContainer.appendChild(star);
                }
            
                function updateStars(){
                    starsContainer.querySelectorAll('span').forEach((s,idx)=>{
                        s.style.color = idx<selected?'gold':'gray';
                    });
                }
            
                // ส่งคะแนน
                document.getElementById('sendBtn').onclick = async ()=>{
                    if(selected===0){ alert("กรุณาเลือกจำนวนดาว"); return; }
                    const res = await fetch(`${baseURL}/api/rate`,{
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({menuId,rating:selected})
                    });
                    const data = await res.json();
                
                    // โหลดค่าเฉลี่ยใหม่
                    loadAverage(menuId, box);
                
                    overlay.style.display='none';
                }
            
                // ปิด overlay
                document.getElementById('closeBtn').onclick = ()=>{
                    overlay.style.display='none';
                }
            });
        });
    </script>
</body>
</html>